<html>
 <head>
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="icon" sizes="16x16 32x32 64x64" href="img/favicon.ico">
  <link rel="icon" type="image/png" sizes="196x196" href="img/favicon-192.png">
  <link rel="icon" type="image/png" sizes="160x160" href="img/favicon-160.png">
  <link rel="icon" type="image/png" sizes="96x96" href="img/favicon-96.png">
  <link rel="icon" type="image/png" sizes="64x64" href="img/favicon-64.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16.png">
  <link rel="apple-touch-icon" href="img/favicon-57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="img/favicon-114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="img/favicon-72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="img/favicon-144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="img/favicon-60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="img/favicon-120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="img/favicon-76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="img/favicon-152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="img/favicon-180.png">
  <meta name="msapplication-TileColor" content="#FFFFFF">
  <meta name="msapplication-TileImage" content="img/favicon-144.png">
  <meta name="msapplication-config" content="/browserconfig.xml">

  <link rel="stylesheet" href="css/styles.css?v=1.0">
  <link rel="stylesheet" type="text/css" href="css/style.css"/>

  <title>BTC/USD with Multiple Indicators</title>
  <style>
   body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
   #indicators-grid {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 30px;
   }
   .status-container { 
    background-color: #fff;
    margin: 10px 0; 
    padding: 15px; 
    border: 1px solid #ccc; 
    border-radius: 8px; 
    width: 300px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
   }
   .statusImage { 
    max-width: 200px;
    height: auto; 
    border-radius: 5px; 
    display: block;
    margin: 10px auto;
   }
   h2 { margin-top: 0; color: #333; }
   .indicatorValue { font-size: 1.2em; font-weight: bold; margin-top: 10px; color: #555; }
   .tradingview-widget-container { height: 600px; margin-top: 30px;}
  </style>
 </head>

 <body>
  
  <div id="indicators-grid">
    <div class="status-container">
      <h2>Sinyal Berdasarkan CMO</h2>
      <img id="cmoStatusImage" class="statusImage" src="media/foto2.png" alt="Status Sinyal CMO">
      <p id="cmoValue" class="indicatorValue">Memuat data...</p>
    </div>

    <div class="status-container">
      <h2>Sinyal Berdasarkan RSI</h2>
      <img id="rsiStatusImage" class="statusImage" src="media/foto2.png" alt="Status Sinyal RSI">
      <p id="rsiValue" class="indicatorValue">Memuat data...</p>
    </div>

    <div class="status-container">
      <h2>Sinyal Berdasarkan Ichimoku</h2>
      <img id="ichimokuStatusImage" class="statusImage" src="media/foto2.png" alt="Status Sinyal Ichimoku">
      <p id="ichimokuStatus" class="indicatorValue">Memuat data...</p>
    </div>
  </div>

  <div class="tradingview-widget-container">
   <div id="tradingview_417af"></div>
   <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
   <script type="text/javascript">
    new TradingView.widget({
     "autosize": true,
     "symbol": "BINANCE:BTCUSDT",
     "interval": "W",
     "timezone": "Europe/Zurich",
     "theme": "Light",
     "style": "1",
     "locale": "en",
     "toolbar_bg": "#f1f3f6",
     "enable_publishing": false,
     "withdateranges": true,
     "hide_side_toolbar": false,
     "allow_symbol_change": true,
     "details": false,
     "studies": [
      "IchimokuCloud@tv-basicstudies",
      "RSI@tv-basicstudies",
      "ChandeMomentumOscillator@tv-basicstudies",
      "StochasticRSI@tv-basicstudies",
      "MACD@tv-basicstudies",
      "Volume@tv-basicstudies"
     ],
     "container_id": "tradingview_417af"
    });
   </script>
  </div>

  <script>
    // --- PENGATURAN YANG BISA ANDA UBAH ---
    const CMO_PERIOD = 14; 
    const CMO_BUY_LEVEL = -50; 
    const CMO_RISKY_LEVEL = 50; 
    
    const RSI_PERIOD = 14;
    const RSI_OVERSOLD = 30;
    const RSI_OVERBOUGHT = 70;

    const UPDATE_INTERVAL_MS = 6000; 

    // --- Elemen DOM ---
    const cmoStatusImage = document.getElementById('cmoStatusImage');
    const cmoValueElement = document.getElementById('cmoValue');
    const rsiStatusImage = document.getElementById('rsiStatusImage');
    const rsiValueElement = document.getElementById('rsiValue');
    const ichimokuStatusImage = document.getElementById('ichimokuStatusImage');
    const ichimokuStatusElement = document.getElementById('ichimokuStatus');

    // --- FUNGSI PERHITUNGAN INDIKATOR ---

    function calculateCMO(closePrices, period) {
      if (closePrices.length <= period) return null;
      let sumUp = 0;
      let sumDown = 0;
      const relevantPrices = closePrices.slice(-(period + 1));
      for (let i = 1; i < relevantPrices.length; i++) {
        const diff = relevantPrices[i] - relevantPrices[i - 1];
        if (diff > 0) sumUp += diff;
        else sumDown += Math.abs(diff);
      }
      if (sumUp + sumDown === 0) return 0;
      return 100 * (sumUp - sumDown) / (sumUp + sumDown);
    }
    
    function calculateRSI(closePrices, period) {
        if (closePrices.length <= period) return null;
        let gains = 0;
        let losses = 0;
        const relevantPrices = closePrices.slice(-(period + 1));

        for (let i = 1; i < relevantPrices.length; i++) {
            const diff = relevantPrices[i] - relevantPrices[i - 1];
            if (diff > 0) {
                gains += diff;
            } else {
                losses += Math.abs(diff);
            }
        }

        const avgGain = gains / period;
        const avgLoss = losses / period;

        if (avgLoss === 0) return 100;
        
        const rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
    }

    function getIchimokuSignal(data) {
        if (data.length < 52) return { signal: 'Netral', text: 'Data tidak cukup' };
        
        const highPrices = data.map(d => parseFloat(d[2]));
        const lowPrices = data.map(d => parseFloat(d[3]));
        const closePrice = parseFloat(data[data.length - 1][4]);

        const getHigh = (arr, periods) => Math.max(...arr.slice(-periods));
        const getLow = (arr, periods) => Math.min(...arr.slice(-periods));

        // Tenkan-sen (Conversion Line)
        const tenkanSen = (getHigh(highPrices, 9) + getLow(lowPrices, 9)) / 2;
        // Kijun-sen (Base Line)
        const kijunSen = (getHigh(highPrices, 26) + getLow(lowPrices, 26)) / 2;
        
        // --- Calculate Cloud for current price position ---
        // We need the cloud from 26 periods ago
        const pastData = data.slice(0, -26);
        const pastHigh = pastData.map(d => parseFloat(d[2]));
        const pastLow = pastData.map(d => parseFloat(d[3]));

        const pastTenkanSen = (getHigh(pastHigh, 9) + getLow(pastLow, 9)) / 2;
        const pastKijunSen = (getHigh(pastHigh, 26) + getLow(pastLow, 26)) / 2;
        
        const senkouSpanA = (pastTenkanSen + pastKijunSen) / 2;
        const senkouSpanB = (getHigh(pastHigh, 52) + getLow(pastLow, 52)) / 2;

        let signal = 'Netral';
        let text = 'Harga di dalam Awan Kumo';
        
        if (closePrice > Math.max(senkouSpanA, senkouSpanB)) { // Above cloud
            if (tenkanSen > kijunSen) {
                signal = 'Beli';
                text = 'Harga di atas awan, sinyal Bullish kuat.';
            } else {
                signal = 'Netral';
                text = 'Harga di atas awan, namun sinyal lemah.';
            }
        } else if (closePrice < Math.min(senkouSpanA, senkouSpanB)) { // Below cloud
            if (tenkanSen < kijunSen) {
                signal = 'Risky';
                text = 'Harga di bawah awan, sinyal Bearish kuat.';
            } else {
                signal = 'Netral';
                text = 'Harga di bawah awan, namun sinyal lemah.';
            }
        }
        
        return { signal, text };
    }

    async function updateAllStatuses() {
      try {
        // Increase limit to 100 to ensure enough data for Ichimoku (needs 52 periods)
        const response = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=100');
        if (!response.ok) {
            throw new Error('Gagal mengambil data dari API Binance');
        }
        const data = await response.json();
        const closePrices = data.map(candle => parseFloat(candle[4]));

        // --- Update CMO ---
        const cmo = calculateCMO(closePrices, CMO_PERIOD);
        if (cmo !== null) {
          cmoValueElement.textContent = `Nilai CMO: ${cmo.toFixed(2)}`;
          if (cmo < CMO_BUY_LEVEL) {
            cmoStatusImage.src = 'media/foto1.png';
            cmoStatusImage.alt = 'Sinyal Beli';
          } else if (cmo > CMO_RISKY_LEVEL) {
            cmoStatusImage.src = 'media/foto3.png';
            cmoStatusImage.alt = 'Sinyal Risky';
          } else {
            cmoStatusImage.src = 'media/foto2.png';
            cmoStatusImage.alt = 'Sinyal Biasa / Netral';
          }
        } else {
            cmoValueElement.textContent = "Data tidak cukup.";
        }

        // --- Update RSI ---
        const rsi = calculateRSI(closePrices, RSI_PERIOD);
        if (rsi !== null) {
            rsiValueElement.textContent = `Nilai RSI: ${rsi.toFixed(2)}`;
            if (rsi < RSI_OVERSOLD) {
                rsiStatusImage.src = 'media/foto1.png';
                rsiStatusImage.alt = 'Oversold (Sinyal Beli)';
            } else if (rsi > RSI_OVERBOUGHT) {
                rsiStatusImage.src = 'media/foto3.png';
                rsiStatusImage.alt = 'Overbought (Sinyal Risky)';
            } else {
                rsiStatusImage.src = 'media/foto2.png';
                rsiStatusImage.alt = 'Netral';
            }
        } else {
            rsiValueElement.textContent = "Data tidak cukup.";
        }
        
        // --- Update Ichimoku Cloud ---
        const ichimoku = getIchimokuSignal(data);
        ichimokuStatusElement.textContent = ichimoku.text;
        if (ichimoku.signal === 'Beli') {
            ichimokuStatusImage.src = 'media/foto1.png';
            ichimokuStatusImage.alt = 'Sinyal Bullish';
        } else if (ichimoku.signal === 'Risky') {
            ichimokuStatusImage.src = 'media/foto3.png';
            ichimokuStatusImage.alt = 'Sinyal Bearish';
        } else {
            ichimokuStatusImage.src = 'media/foto2.png';
            ichimokuStatusImage.alt = 'Sinyal Netral';
        }

      } catch (error) {
        console.error("Terjadi kesalahan:", error);
        cmoValueElement.textContent = "Gagal memuat data.";
        rsiValueElement.textContent = "Gagal memuat data.";
        ichimokuStatusElement.textContent = "Gagal memuat data.";
      }
    }

    updateAllStatuses();
    setInterval(updateAllStatuses, UPDATE_INTERVAL_MS);
  </script>

 </body>
</html>